var Player = (function () {
    function Player(scene, ground) {
        var _this = this;
        this.jumpVelocity = 10;
        this.hitDistance = 0.7;
        this.fallMultiplier = 2.5;
        this.lowJumpMultiplier = 2;
        this.moveSpeed = 1;
        this.sideLength = 1;
        this.requiredKeys = {
            32: false,
            37: false,
            38: false,
            39: false,
            40: false
        };
        this.scene = scene;
        this.ground = ground;
        this.playerShape = BABYLON.MeshBuilder.CreateBox('player', {
            width: 1,
            height: 1,
            depth: 1
        }, this.scene);
        this.playerShape.position = new BABYLON.Vector3(0, 5, 0);
        this.playerShape.checkCollisions = true;
        this.playerShape.physicsImpostor = new BABYLON.PhysicsImpostor(this.playerShape, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 1, friction: 0, restitution: 0 }, this.scene);
        this.playerShape.physicsImpostor.setLinearVelocity(BABYLON.Vector3.Zero());
        window.addEventListener('keydown', function (event) {
            event.preventDefault();
            _this.handleKeyDown(event);
        });
        window.addEventListener('keyup', function (event) {
            event.preventDefault();
            _this.handleKeyUp(event);
        });
    }
    Player.prototype.handleKeyDown = function (event) {
        var key = event.keyCode;
        if (key in this.requiredKeys) {
            this.requiredKeys[key] = true;
        }
    };
    Player.prototype.handleKeyUp = function (event) {
        var key = event.keyCode;
        if (key in this.requiredKeys) {
            this.requiredKeys[key] = false;
        }
    };
    Player.prototype.basicJump = function () {
        this.ray = new BABYLON.Ray(this.playerShape.position, BABYLON.Vector3.Up().negate(), 10);
        var hit = this.ray.intersectsMeshes([this.ground], true);
        if (hit.length) {
            if (hit[0].distance <= this.hitDistance && this.requiredKeys[32]) {
                var zVelocity = this.playerShape.physicsImpostor.getLinearVelocity().z;
                this.playerShape.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(0, this.jumpVelocity, zVelocity));
                this.requiredKeys[32] = false;
            }
        }
    };
    Player.prototype.moveForwardAndBack = function () {
        var moveZ = 0;
        if (this.requiredKeys[38]) {
            moveZ = -1;
        }
        else if (this.requiredKeys[40]) {
            moveZ = 1;
        }
        var moveSpeed = this.moveSpeed * moveZ;
        var yVelocity = this.playerShape.physicsImpostor.getLinearVelocity().y;
        this.playerShape.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(0, yVelocity, moveSpeed));
    };
    Player.prototype.update = function () {
        this.moveForwardAndBack();
        this.basicJump();
    };
    return Player;
}());
var canvasHolder = document.getElementById('canvas-holder');
var canvas = document.createElement('canvas');
canvas.width = window.innerWidth - 25;
canvas.height = window.innerHeight - 25;
canvasHolder.appendChild(canvas);
var fpsLabel = document.getElementById('fpsLabel');
var engine = new BABYLON.Engine(canvas, true);
var scene = new BABYLON.Scene(engine);
scene.collisionsEnabled = true;
scene.workerCollisions = true;
scene.enablePhysics(new BABYLON.Vector3(0, -9.81, 0), new BABYLON.CannonJSPlugin());
var camera = new BABYLON.FollowCamera('mainCamera', new BABYLON.Vector3(0, 0, 0), scene);
camera.heightOffset = 10;
camera.radius = 20;
camera.noRotationConstraint = false;
scene.activeCamera = camera;
var light = new BABYLON.HemisphericLight("pointLight", new BABYLON.Vector3(5, 7, 5), scene);
light.intensity = 0.7;
var ground = BABYLON.MeshBuilder.CreateGround('ground', {
    width: 20, height: 20, subdivisions: 2
}, scene);
ground.position = BABYLON.Vector3.Zero();
ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0.9 }, scene);
ground.isPickable = true;
var player = new Player(scene, ground);
camera.lockedTarget = player.playerShape;
scene.registerBeforeRender(function () {
    player.update();
});
engine.runRenderLoop(function () {
    scene.render();
    fpsLabel.innerHTML = engine.getFps().toFixed() + " fps";
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9NYXJpby9wbGF5ZXIudHMiLCJzcmMvTWFyaW8vaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0E7SUEwQkksZ0JBQVksS0FBb0IsRUFBRSxNQUFvQjtRQUF0RCxpQkEwQkM7UUEzQ0QsaUJBQVksR0FBVyxFQUFFLENBQUM7UUFDMUIsZ0JBQVcsR0FBVyxHQUFHLENBQUM7UUFDMUIsbUJBQWMsR0FBVyxHQUFHLENBQUM7UUFDN0Isc0JBQWlCLEdBQVcsQ0FBQyxDQUFDO1FBRTlCLGNBQVMsR0FBVyxDQUFDLENBQUM7UUFFdEIsZUFBVSxHQUFXLENBQUMsQ0FBQztRQUV2QixpQkFBWSxHQUFHO1lBQ1gsRUFBRSxFQUFFLEtBQUs7WUFDVCxFQUFFLEVBQUUsS0FBSztZQUNULEVBQUUsRUFBRSxLQUFLO1lBQ1QsRUFBRSxFQUFFLEtBQUs7WUFDVCxFQUFFLEVBQUUsS0FBSztTQUNaLENBQUE7UUFHRyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUVyQixJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRTtZQUN2RCxLQUFLLEVBQUUsQ0FBQztZQUNSLE1BQU0sRUFBRSxDQUFDO1lBQ1QsS0FBSyxFQUFFLENBQUM7U0FDWCxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNmLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3pELElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztRQUV4QyxJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxlQUFlLENBQzFELElBQUksQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsV0FBVyxFQUFFLENBQUMsRUFBRSxFQUMvRixJQUFJLENBQUMsS0FBSyxDQUNiLENBQUM7UUFDRixJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFFM0UsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxVQUFBLEtBQUs7WUFDcEMsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3ZCLEtBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFVBQUEsS0FBSztZQUNsQyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDdkIsS0FBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyw4QkFBYSxHQUFyQixVQUFzQixLQUFvQjtRQUN0QyxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO1FBQ3hCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUMzQixJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNsQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLDRCQUFXLEdBQW5CLFVBQW9CLEtBQW9CO1FBQ3BDLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDeEIsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ25DLENBQUM7SUFDTCxDQUFDO0lBRU8sMEJBQVMsR0FBakI7UUFDSSxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3pGLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFekQsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFFYixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQy9ELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN2RSxJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFFekcsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDbEMsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0lBRU8sbUNBQWtCLEdBQTFCO1FBQ0ksSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEIsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2YsQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsQ0FBQztRQUVELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3ZDLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDckcsQ0FBQztJQUVELHVCQUFNLEdBQU47UUFDSSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUMxQixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUNMLGFBQUM7QUFBRCxDQXBHQSxBQW9HQyxJQUFBO0FDcEdELElBQU0sWUFBWSxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDOUQsSUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNoRCxNQUFNLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO0FBQ3RDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7QUFDeEMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUVqQyxJQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBRXJELElBQU0sTUFBTSxHQUFtQixJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBRWhFLElBQU0sS0FBSyxHQUFHLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN4QyxLQUFLLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO0FBQy9CLEtBQUssQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7QUFDOUIsS0FBSyxDQUFDLGFBQWEsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7QUFFcEYsSUFBTSxNQUFNLEdBQUcsSUFBSSxPQUFPLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUMzRixNQUFNLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztBQUN6QixNQUFNLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztBQUNuQixNQUFNLENBQUMsb0JBQW9CLEdBQUcsS0FBSyxDQUFDO0FBQ3BDLEtBQUssQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDO0FBRTVCLElBQU0sS0FBSyxHQUFHLElBQUksT0FBTyxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM5RixLQUFLLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQztBQUV0QixJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUU7SUFDdEQsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDO0NBQ3pDLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDVixNQUFNLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDekMsTUFBTSxDQUFDLGVBQWUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxlQUFlLENBQUMsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxXQUFXLEVBQUUsR0FBRyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDeEksTUFBTSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7QUFFekIsSUFBTSxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztBQUN6QyxLQUFLLENBQUMsb0JBQW9CLENBQUM7SUFDdkIsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ3BCLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxDQUFDLGFBQWEsQ0FBQztJQUNqQixLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDZixRQUFRLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxNQUFNLENBQUM7QUFDNUQsQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoiYnVuZGxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4vLi4vLi4vdHlwaW5ncy9iYWJ5bG9uLmQudHNcIiAvPlxyXG5cclxuXHJcbmNsYXNzIFBsYXllciB7XHJcbiAgICB2ZWxvY2l0eTogQkFCWUxPTi5WZWN0b3IzO1xyXG5cclxuICAgIHBsYXllclNoYXBlOiBCQUJZTE9OLk1lc2g7XHJcbiAgICByYXk6IEJBQllMT04uUmF5O1xyXG5cclxuICAgIHNjZW5lOiBCQUJZTE9OLlNjZW5lO1xyXG4gICAgZ3JvdW5kOiBCQUJZTE9OLk1lc2g7XHJcblxyXG4gICAganVtcFZlbG9jaXR5OiBudW1iZXIgPSAxMDtcclxuICAgIGhpdERpc3RhbmNlOiBudW1iZXIgPSAwLjc7XHJcbiAgICBmYWxsTXVsdGlwbGllcjogbnVtYmVyID0gMi41O1xyXG4gICAgbG93SnVtcE11bHRpcGxpZXI6IG51bWJlciA9IDI7XHJcblxyXG4gICAgbW92ZVNwZWVkOiBudW1iZXIgPSAxO1xyXG5cclxuICAgIHNpZGVMZW5ndGg6IG51bWJlciA9IDE7XHJcblxyXG4gICAgcmVxdWlyZWRLZXlzID0ge1xyXG4gICAgICAgIDMyOiBmYWxzZSwgLy8gU1BBQ0VcclxuICAgICAgICAzNzogZmFsc2UsIC8vIExFRlRcclxuICAgICAgICAzODogZmFsc2UsIC8vIFRPUFxyXG4gICAgICAgIDM5OiBmYWxzZSwgLy8gUklHSFRcclxuICAgICAgICA0MDogZmFsc2UgLy8gRE9XTlxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHNjZW5lOiBCQUJZTE9OLlNjZW5lLCBncm91bmQ6IEJBQllMT04uTWVzaCkge1xyXG4gICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTtcclxuICAgICAgICB0aGlzLmdyb3VuZCA9IGdyb3VuZDtcclxuXHJcbiAgICAgICAgdGhpcy5wbGF5ZXJTaGFwZSA9IEJBQllMT04uTWVzaEJ1aWxkZXIuQ3JlYXRlQm94KCdwbGF5ZXInLCB7XHJcbiAgICAgICAgICAgIHdpZHRoOiAxLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IDEsXHJcbiAgICAgICAgICAgIGRlcHRoOiAxXHJcbiAgICAgICAgfSwgdGhpcy5zY2VuZSk7XHJcbiAgICAgICAgdGhpcy5wbGF5ZXJTaGFwZS5wb3NpdGlvbiA9IG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgNSwgMCk7XHJcbiAgICAgICAgdGhpcy5wbGF5ZXJTaGFwZS5jaGVja0NvbGxpc2lvbnMgPSB0cnVlO1xyXG4gICAgICAgIC8vIEZyaWN0aW9uIGFuZCBSZXN0aXR1dGlvbiBpcyBzZXQgdG8gMCB0byBwcmV2ZW50IHJvdGF0aW9uIHdoZW4gbW92aW5nIGFyb3VuZCAoZm9yIGEgY3ViZSlcclxuICAgICAgICB0aGlzLnBsYXllclNoYXBlLnBoeXNpY3NJbXBvc3RvciA9IG5ldyBCQUJZTE9OLlBoeXNpY3NJbXBvc3RvcihcclxuICAgICAgICAgICAgdGhpcy5wbGF5ZXJTaGFwZSwgQkFCWUxPTi5QaHlzaWNzSW1wb3N0b3IuQm94SW1wb3N0b3IsIHsgbWFzczogMSwgZnJpY3Rpb246IDAsIHJlc3RpdHV0aW9uOiAwIH0sXHJcbiAgICAgICAgICAgIHRoaXMuc2NlbmVcclxuICAgICAgICApO1xyXG4gICAgICAgIHRoaXMucGxheWVyU2hhcGUucGh5c2ljc0ltcG9zdG9yLnNldExpbmVhclZlbG9jaXR5KEJBQllMT04uVmVjdG9yMy5aZXJvKCkpO1xyXG5cclxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGV2ZW50ID0+IHtcclxuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgdGhpcy5oYW5kbGVLZXlEb3duKGV2ZW50KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCBldmVudCA9PiB7XHJcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlS2V5VXAoZXZlbnQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGFuZGxlS2V5RG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xyXG4gICAgICAgIGxldCBrZXkgPSBldmVudC5rZXlDb2RlO1xyXG4gICAgICAgIGlmIChrZXkgaW4gdGhpcy5yZXF1aXJlZEtleXMpIHtcclxuICAgICAgICAgICAgdGhpcy5yZXF1aXJlZEtleXNba2V5XSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGFuZGxlS2V5VXAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcclxuICAgICAgICBsZXQga2V5ID0gZXZlbnQua2V5Q29kZTtcclxuICAgICAgICBpZiAoa2V5IGluIHRoaXMucmVxdWlyZWRLZXlzKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVxdWlyZWRLZXlzW2tleV0gPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBiYXNpY0p1bXAoKSB7XHJcbiAgICAgICAgdGhpcy5yYXkgPSBuZXcgQkFCWUxPTi5SYXkodGhpcy5wbGF5ZXJTaGFwZS5wb3NpdGlvbiwgQkFCWUxPTi5WZWN0b3IzLlVwKCkubmVnYXRlKCksIDEwKTtcclxuICAgICAgICBsZXQgaGl0ID0gdGhpcy5yYXkuaW50ZXJzZWN0c01lc2hlcyhbdGhpcy5ncm91bmRdLCB0cnVlKTtcclxuXHJcbiAgICAgICAgaWYgKGhpdC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgLy8gRml4TWU6IENoYW5nZSB0byBtaW4gZGlzdGFuY2UgYW5kIGNoZWNrXHJcbiAgICAgICAgICAgIGlmIChoaXRbMF0uZGlzdGFuY2UgPD0gdGhpcy5oaXREaXN0YW5jZSAmJiB0aGlzLnJlcXVpcmVkS2V5c1szMl0pIHtcclxuICAgICAgICAgICAgICAgIGxldCB6VmVsb2NpdHkgPSB0aGlzLnBsYXllclNoYXBlLnBoeXNpY3NJbXBvc3Rvci5nZXRMaW5lYXJWZWxvY2l0eSgpLno7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBsYXllclNoYXBlLnBoeXNpY3NJbXBvc3Rvci5zZXRMaW5lYXJWZWxvY2l0eShuZXcgQkFCWUxPTi5WZWN0b3IzKDAsIHRoaXMuanVtcFZlbG9jaXR5LCB6VmVsb2NpdHkpKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlcXVpcmVkS2V5c1szMl0gPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG1vdmVGb3J3YXJkQW5kQmFjaygpIHtcclxuICAgICAgICBsZXQgbW92ZVogPSAwO1xyXG4gICAgICAgIGlmICh0aGlzLnJlcXVpcmVkS2V5c1szOF0pIHtcclxuICAgICAgICAgICAgbW92ZVogPSAtMTtcclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMucmVxdWlyZWRLZXlzWzQwXSkge1xyXG4gICAgICAgICAgICBtb3ZlWiA9IDE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbW92ZVNwZWVkID0gdGhpcy5tb3ZlU3BlZWQgKiBtb3ZlWjtcclxuICAgICAgICBsZXQgeVZlbG9jaXR5ID0gdGhpcy5wbGF5ZXJTaGFwZS5waHlzaWNzSW1wb3N0b3IuZ2V0TGluZWFyVmVsb2NpdHkoKS55O1xyXG4gICAgICAgIHRoaXMucGxheWVyU2hhcGUucGh5c2ljc0ltcG9zdG9yLnNldExpbmVhclZlbG9jaXR5KG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgeVZlbG9jaXR5LCBtb3ZlU3BlZWQpKTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGUoKSB7XHJcbiAgICAgICAgdGhpcy5tb3ZlRm9yd2FyZEFuZEJhY2soKTtcclxuICAgICAgICB0aGlzLmJhc2ljSnVtcCgpO1xyXG4gICAgfVxyXG59IiwiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4vLi4vLi4vdHlwaW5ncy9iYWJ5bG9uLmQudHNcIiAvPlxyXG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi9wbGF5ZXIudHNcIiAvPlxyXG5cclxuY29uc3QgY2FudmFzSG9sZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NhbnZhcy1ob2xkZXInKTtcclxuY29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XHJcbmNhbnZhcy53aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoIC0gMjU7XHJcbmNhbnZhcy5oZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgLSAyNTtcclxuY2FudmFzSG9sZGVyLmFwcGVuZENoaWxkKGNhbnZhcyk7XHJcblxyXG5jb25zdCBmcHNMYWJlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmcHNMYWJlbCcpO1xyXG5cclxuY29uc3QgZW5naW5lOiBCQUJZTE9OLkVuZ2luZSA9IG5ldyBCQUJZTE9OLkVuZ2luZShjYW52YXMsIHRydWUpO1xyXG5cclxuY29uc3Qgc2NlbmUgPSBuZXcgQkFCWUxPTi5TY2VuZShlbmdpbmUpO1xyXG5zY2VuZS5jb2xsaXNpb25zRW5hYmxlZCA9IHRydWU7XHJcbnNjZW5lLndvcmtlckNvbGxpc2lvbnMgPSB0cnVlO1xyXG5zY2VuZS5lbmFibGVQaHlzaWNzKG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgLTkuODEsIDApLCBuZXcgQkFCWUxPTi5DYW5ub25KU1BsdWdpbigpKTtcclxuXHJcbmNvbnN0IGNhbWVyYSA9IG5ldyBCQUJZTE9OLkZvbGxvd0NhbWVyYSgnbWFpbkNhbWVyYScsIG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgMCwgMCksIHNjZW5lKTtcclxuY2FtZXJhLmhlaWdodE9mZnNldCA9IDEwO1xyXG5jYW1lcmEucmFkaXVzID0gMjA7XHJcbmNhbWVyYS5ub1JvdGF0aW9uQ29uc3RyYWludCA9IGZhbHNlO1xyXG5zY2VuZS5hY3RpdmVDYW1lcmEgPSBjYW1lcmE7XHJcblxyXG5jb25zdCBsaWdodCA9IG5ldyBCQUJZTE9OLkhlbWlzcGhlcmljTGlnaHQoXCJwb2ludExpZ2h0XCIsIG5ldyBCQUJZTE9OLlZlY3RvcjMoNSwgNywgNSksIHNjZW5lKTtcclxubGlnaHQuaW50ZW5zaXR5ID0gMC43O1xyXG5cclxuY29uc3QgZ3JvdW5kID0gQkFCWUxPTi5NZXNoQnVpbGRlci5DcmVhdGVHcm91bmQoJ2dyb3VuZCcsIHtcclxuICAgIHdpZHRoOiAyMCwgaGVpZ2h0OiAyMCwgc3ViZGl2aXNpb25zOiAyXHJcbn0sIHNjZW5lKTtcclxuZ3JvdW5kLnBvc2l0aW9uID0gQkFCWUxPTi5WZWN0b3IzLlplcm8oKTtcclxuZ3JvdW5kLnBoeXNpY3NJbXBvc3RvciA9IG5ldyBCQUJZTE9OLlBoeXNpY3NJbXBvc3Rvcihncm91bmQsIEJBQllMT04uUGh5c2ljc0ltcG9zdG9yLkJveEltcG9zdG9yLCB7IG1hc3M6IDAsIHJlc3RpdHV0aW9uOiAwLjkgfSwgc2NlbmUpO1xyXG5ncm91bmQuaXNQaWNrYWJsZSA9IHRydWU7XHJcblxyXG5jb25zdCBwbGF5ZXIgPSBuZXcgUGxheWVyKHNjZW5lLCBncm91bmQpO1xyXG5jYW1lcmEubG9ja2VkVGFyZ2V0ID0gcGxheWVyLnBsYXllclNoYXBlO1xyXG5zY2VuZS5yZWdpc3RlckJlZm9yZVJlbmRlcigoKSA9PiB7XHJcbiAgICBwbGF5ZXIudXBkYXRlKCk7XHJcbn0pO1xyXG5cclxuZW5naW5lLnJ1blJlbmRlckxvb3AoKCkgPT4ge1xyXG4gICAgc2NlbmUucmVuZGVyKCk7XHJcbiAgICBmcHNMYWJlbC5pbm5lckhUTUwgPSBlbmdpbmUuZ2V0RnBzKCkudG9GaXhlZCgpICsgXCIgZnBzXCI7XHJcbn0pOyJdfQ==
