'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

/// <reference path="./../../typings/babylon.d.ts" />

var Ball = function () {
    function Ball(scene, spawnPosition, ballId) {
        var color = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 1;

        _classCallCheck(this, Ball);

        this.minBallSpeed = 5;
        this.maxBallSpeed = 20;

        this.ball = BABYLON.MeshBuilder.CreateSphere('playBall', {
            segments: 16,
            diameter: 1
        }, scene);
        this.ball.physicsImpostor = new BABYLON.PhysicsImpostor(this.ball, BABYLON.PhysicsImpostor.SphereImpostor, {
            mass: 1,
            friction: 0,
            restitution: 1
        }, scene);
        this.ball.position = spawnPosition;
        this.ball.physicsImpostor.uniqueId = ballId;

        this.initialPosition = spawnPosition.clone();
        this.isLaunched = false;
        this.color = color;
    }

    _createClass(Ball, [{
        key: 'lockPositionToPlayerPaddle',
        value: function lockPositionToPlayerPaddle(playerPaddleVelocity) {
            this.ball.physicsImpostor.setLinearVelocity(playerPaddleVelocity);
        }
    }, {
        key: 'launchBall',
        value: function launchBall(keyStates, playerPaddleVelocity) {
            if (keyStates[32]) {
                this.isLaunched = true;

                this.ball.physicsImpostor.setLinearVelocity(playerPaddleVelocity.x, 0, Math.random() * 10);
            }
        }
    }, {
        key: 'setCollisionComponents',
        value: function setCollisionComponents(imposters) {
            this.ball.physicsImpostor.registerOnPhysicsCollide(imposters, this.onTriggerEnter);
        }
    }, {
        key: 'onTriggerEnter',
        value: function onTriggerEnter(ballPhysicsImposter, collidedAgainst) {
            var velocityX = collidedAgainst.getLinearVelocity().x;
            var velocityXBall = ballPhysicsImposter.getLinearVelocity().x;
            var velocityZ = -ballPhysicsImposter.getLinearVelocity().z;

            ballPhysicsImposter.setLinearVelocity(new BABYLON.Vector3(velocityX - velocityXBall, 0, velocityZ));

            collidedAgainst.setAngularVelocity(BABYLON.Vector3.Zero());
        }
    }, {
        key: 'limitBallVelocity',
        value: function limitBallVelocity() {
            var velocityZ = this.ball.physicsImpostor.getLinearVelocity().z;
            var velocityZAbs = Math.abs(velocityZ);
            var clampedVelocityZ = BABYLON.MathTools.Clamp(velocityZAbs, this.minBallSpeed, this.maxBallSpeed);
            var direction = Math.sign(velocityZ);

            var velocityX = this.ball.physicsImpostor.getLinearVelocity().x;

            this.ball.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(velocityX, 0, clampedVelocityZ * direction));
        }
    }, {
        key: 'update',
        value: function update(keyStates, playerPaddleVelocity) {
            if (this.isLaunched) this.limitBallVelocity();else {
                this.lockPositionToPlayerPaddle(playerPaddleVelocity);
            }

            if (!this.isLaunched) {
                this.launchBall(keyStates, playerPaddleVelocity);
            }
        }
    }]);

    return Ball;
}();
/// <reference path="./../../typings/babylon.d.ts" />

var Paddle = function () {
    function Paddle(name, scene, spawnPosition, paddleId, isAI) {
        var color = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : 1;

        _classCallCheck(this, Paddle);

        this.paddle = BABYLON.MeshBuilder.CreateBox('paddle' + name, {
            width: 5,
            height: 1,
            depth: 1
        }, scene);
        this.paddle.position = spawnPosition;
        this.paddle.physicsImpostor = new BABYLON.PhysicsImpostor(this.paddle, BABYLON.PhysicsImpostor.BoxImpostor, {
            mass: 1,
            friction: 0,
            restitution: 0
        }, scene);
        this.paddle.physicsImpostor.setLinearVelocity(BABYLON.Vector3.Zero());
        this.paddle.physicsImpostor.uniqueId = paddleId;

        this.initialPosition = spawnPosition.clone();
        this.color = color;
        this.movementSpeed = 5;

        this.isAI = isAI;
    }

    _createClass(Paddle, [{
        key: 'movePaddle',
        value: function movePaddle(keyStates) {
            if (keyStates[37]) {
                this.paddle.physicsImpostor.setLinearVelocity(BABYLON.Vector3.Left().scale(this.movementSpeed));
            } else if (keyStates[39]) {
                this.paddle.physicsImpostor.setLinearVelocity(BABYLON.Vector3.Right().scale(this.movementSpeed));
            }

            if (!keyStates[37] && !keyStates[39] || keyStates[37] && keyStates[39]) this.paddle.physicsImpostor.setLinearVelocity(BABYLON.Vector3.Zero());
        }
    }, {
        key: 'movePaddleAI',
        value: function movePaddleAI(ballMesh) {
            var desiredDirection = Math.sign(ballMesh.position.x - this.paddle.position.x);

            if (desiredDirection === -1) {
                this.paddle.physicsImpostor.setLinearVelocity(BABYLON.Vector3.Left().scale(this.movementSpeed));
            } else if (desiredDirection === 1) {
                this.paddle.physicsImpostor.setLinearVelocity(BABYLON.Vector3.Right().scale(this.movementSpeed));
            } else {
                this.paddle.physicsImpostor.setLinearVelocity(BABYLON.Vector3.Zero());
            }
        }
    }, {
        key: 'update',
        value: function update(keyStates, ball) {
            if (!this.isAI) this.movePaddle(keyStates);else this.movePaddleAI(ball);

            this.paddle.physicsImpostor.setAngularVelocity(BABYLON.Vector3.Zero());
        }
    }]);

    return Paddle;
}();
/// <reference path="./../../typings/babylon.d.ts" />
/// <reference path="./paddle.js" />
/// <reference path="./ball.js" />

// ToDo: Remove `showBoundingBox` from all bodies

var canvasHolder = document.getElementById('canvas-holder');
var canvas = document.createElement('canvas');
canvas.width = window.innerWidth - 25;
canvas.height = window.innerHeight - 30;
canvasHolder.appendChild(canvas);
var engine = new BABYLON.Engine(canvas, true);

var keyStates = {
    32: false, // SPACE
    37: false, // LEFT
    38: false, // UP
    39: false, // RIGHT
    40: false // DOWN
};
window.addEventListener('keydown', function (event) {
    if (event.keyCode in keyStates) keyStates[event.keyCode] = true;
});
window.addEventListener('keyup', function (event) {
    if (event.keyCode in keyStates) keyStates[event.keyCode] = false;
});

var createScene = function createScene() {
    var scene = new BABYLON.Scene(engine);
    scene.enablePhysics(new BABYLON.Vector3(0, -9.81, 0), new BABYLON.CannonJSPlugin());
    scene.collisionsEnabled = true;
    scene.workerCollisions = true;

    var camera = new BABYLON.FreeCamera('mainCamera', new BABYLON.Vector3(0, 20, -60), scene);
    camera.setTarget(BABYLON.Vector3.Zero());

    var light = new BABYLON.HemisphericLight('mainLight', new BABYLON.Vector3(0, 1, 0), scene);

    var ground = BABYLON.MeshBuilder.CreateGround('mainGround', {
        width: 32,
        height: 70,
        subdivisions: 2
    }, scene);
    ground.position = BABYLON.Vector3.Zero();
    ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsImpostor.BoxImpostor, {
        mass: 0,
        friction: 0,
        restitution: 0
    }, scene);

    var leftBar = BABYLON.MeshBuilder.CreateBox('leftBar', {
        width: 2,
        height: 2,
        depth: 70
    }, scene);
    leftBar.position = new BABYLON.Vector3(-15, 1, 0);
    leftBar.physicsImpostor = new BABYLON.PhysicsImpostor(leftBar, BABYLON.PhysicsImpostor.BoxImpostor, {
        mass: 0,
        friction: 0,
        restitution: 1
    });

    var rightBar = BABYLON.MeshBuilder.CreateBox('rightBar', {
        width: 2,
        height: 2,
        depth: 70
    }, scene);
    rightBar.position = new BABYLON.Vector3(15, 1, 0);
    rightBar.physicsImpostor = new BABYLON.PhysicsImpostor(rightBar, BABYLON.PhysicsImpostor.BoxImpostor, {
        mass: 0,
        friction: 0,
        restitution: 1
    });

    return scene;
};
var scene = createScene();
// new BABYLON.Vector3(0, 0.5, -34)

var player_1 = new Paddle('player_1', scene, new BABYLON.Vector3(0, 0.5, -34), 2, false);
var aiPlayer = new Paddle('aiPlayer', scene, new BABYLON.Vector3(0, 0.5, 34), 3, true);
var playingBall = new Ball(scene, new BABYLON.Vector3(0, 0.5, -33), 1);

engine.runRenderLoop(function () {
    playingBall.update(keyStates, player_1.paddle.physicsImpostor.getLinearVelocity());
    player_1.update(keyStates, playingBall.ball);
    aiPlayer.update(keyStates, playingBall.ball);
    scene.render();
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJ1bmRsZS5qcyJdLCJuYW1lcyI6WyJCYWxsIiwic2NlbmUiLCJzcGF3blBvc2l0aW9uIiwiYmFsbElkIiwiY29sb3IiLCJtaW5CYWxsU3BlZWQiLCJtYXhCYWxsU3BlZWQiLCJiYWxsIiwiQkFCWUxPTiIsIk1lc2hCdWlsZGVyIiwiQ3JlYXRlU3BoZXJlIiwic2VnbWVudHMiLCJkaWFtZXRlciIsInBoeXNpY3NJbXBvc3RvciIsIlBoeXNpY3NJbXBvc3RvciIsIlNwaGVyZUltcG9zdG9yIiwibWFzcyIsImZyaWN0aW9uIiwicmVzdGl0dXRpb24iLCJwb3NpdGlvbiIsInVuaXF1ZUlkIiwiaW5pdGlhbFBvc2l0aW9uIiwiY2xvbmUiLCJpc0xhdW5jaGVkIiwicGxheWVyUGFkZGxlVmVsb2NpdHkiLCJzZXRMaW5lYXJWZWxvY2l0eSIsImtleVN0YXRlcyIsIngiLCJNYXRoIiwicmFuZG9tIiwiaW1wb3N0ZXJzIiwicmVnaXN0ZXJPblBoeXNpY3NDb2xsaWRlIiwib25UcmlnZ2VyRW50ZXIiLCJiYWxsUGh5c2ljc0ltcG9zdGVyIiwiY29sbGlkZWRBZ2FpbnN0IiwidmVsb2NpdHlYIiwiZ2V0TGluZWFyVmVsb2NpdHkiLCJ2ZWxvY2l0eVhCYWxsIiwidmVsb2NpdHlaIiwieiIsIlZlY3RvcjMiLCJzZXRBbmd1bGFyVmVsb2NpdHkiLCJaZXJvIiwidmVsb2NpdHlaQWJzIiwiYWJzIiwiY2xhbXBlZFZlbG9jaXR5WiIsIk1hdGhUb29scyIsIkNsYW1wIiwiZGlyZWN0aW9uIiwic2lnbiIsImxpbWl0QmFsbFZlbG9jaXR5IiwibG9ja1Bvc2l0aW9uVG9QbGF5ZXJQYWRkbGUiLCJsYXVuY2hCYWxsIiwiUGFkZGxlIiwibmFtZSIsInBhZGRsZUlkIiwiaXNBSSIsInBhZGRsZSIsIkNyZWF0ZUJveCIsIndpZHRoIiwiaGVpZ2h0IiwiZGVwdGgiLCJCb3hJbXBvc3RvciIsIm1vdmVtZW50U3BlZWQiLCJMZWZ0Iiwic2NhbGUiLCJSaWdodCIsImJhbGxNZXNoIiwiZGVzaXJlZERpcmVjdGlvbiIsIm1vdmVQYWRkbGUiLCJtb3ZlUGFkZGxlQUkiLCJjYW52YXNIb2xkZXIiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwiY2FudmFzIiwiY3JlYXRlRWxlbWVudCIsIndpbmRvdyIsImlubmVyV2lkdGgiLCJpbm5lckhlaWdodCIsImFwcGVuZENoaWxkIiwiZW5naW5lIiwiRW5naW5lIiwiYWRkRXZlbnRMaXN0ZW5lciIsImV2ZW50Iiwia2V5Q29kZSIsImNyZWF0ZVNjZW5lIiwiU2NlbmUiLCJlbmFibGVQaHlzaWNzIiwiQ2Fubm9uSlNQbHVnaW4iLCJjb2xsaXNpb25zRW5hYmxlZCIsIndvcmtlckNvbGxpc2lvbnMiLCJjYW1lcmEiLCJGcmVlQ2FtZXJhIiwic2V0VGFyZ2V0IiwibGlnaHQiLCJIZW1pc3BoZXJpY0xpZ2h0IiwiZ3JvdW5kIiwiQ3JlYXRlR3JvdW5kIiwic3ViZGl2aXNpb25zIiwibGVmdEJhciIsInJpZ2h0QmFyIiwicGxheWVyXzEiLCJhaVBsYXllciIsInBsYXlpbmdCYWxsIiwicnVuUmVuZGVyTG9vcCIsInVwZGF0ZSIsInJlbmRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0lBRU1BLEk7QUFDRixrQkFBWUMsS0FBWixFQUFtQkMsYUFBbkIsRUFBa0NDLE1BQWxDLEVBQXFEO0FBQUEsWUFBWEMsS0FBVyx1RUFBSCxDQUFHOztBQUFBOztBQUNqRCxhQUFLQyxZQUFMLEdBQW9CLENBQXBCO0FBQ0EsYUFBS0MsWUFBTCxHQUFvQixFQUFwQjs7QUFFQSxhQUFLQyxJQUFMLEdBQVlDLFFBQVFDLFdBQVIsQ0FBb0JDLFlBQXBCLENBQWlDLFVBQWpDLEVBQTZDO0FBQ3JEQyxzQkFBVSxFQUQyQztBQUVyREMsc0JBQVU7QUFGMkMsU0FBN0MsRUFHVFgsS0FIUyxDQUFaO0FBSUEsYUFBS00sSUFBTCxDQUFVTSxlQUFWLEdBQTRCLElBQUlMLFFBQVFNLGVBQVosQ0FDeEIsS0FBS1AsSUFEbUIsRUFFeEJDLFFBQVFNLGVBQVIsQ0FBd0JDLGNBRkEsRUFF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SixDQUFXLFVBQVgsRUFBdUJwRCxLQUF2QixFQUE4QixJQUFJTyxRQUFRZ0MsT0FBWixDQUFvQixDQUFwQixFQUF1QixHQUF2QixFQUE0QixDQUFDLEVBQTdCLENBQTlCLEVBQWdFLENBQWhFLEVBQW1FLEtBQW5FLENBQWpCO0FBQ0EsSUFBTThELFdBQVcsSUFBSWpELE1BQUosQ0FBVyxVQUFYLEVBQXVCcEQsS0FBdkIsRUFBOEIsSUFBSU8sUUFBUWdDLE9BQVosQ0FBb0IsQ0FBcEIsRUFBdUIsR0FBdkIsRUFBNEIsRUFBNUIsQ0FBOUIsRUFBK0QsQ0FBL0QsRUFBa0UsSUFBbEUsQ0FBakI7QUFDQSxJQUFNK0QsY0FBYyxJQUFJdkcsSUFBSixDQUFTQyxLQUFULEVBQWdCLElBQUlPLFFBQVFnQyxPQUFaLENBQW9CLENBQXBCLEVBQXVCLEdBQXZCLEVBQTRCLENBQUMsRUFBN0IsQ0FBaEIsRUFBa0QsQ0FBbEQsQ0FBcEI7O0FBRUF3QyxPQUFPd0IsYUFBUCxDQUFxQixZQUFNO0FBQ3ZCRCxnQkFBWUUsTUFBWixDQUFtQi9FLFNBQW5CLEVBQThCMkUsU0FBUzVDLE1BQVQsQ0FBZ0I1QyxlQUFoQixDQUFnQ3VCLGlCQUFoQyxFQUE5QjtBQUNBaUUsYUFBU0ksTUFBVCxDQUFnQi9FLFNBQWhCLEVBQTJCNkUsWUFBWWhHLElBQXZDO0FBQ0ErRixhQUFTRyxNQUFULENBQWdCL0UsU0FBaEIsRUFBMkI2RSxZQUFZaEcsSUFBdkM7QUFDQU4sVUFBTXlHLE1BQU47QUFDSCxDQUxEIiwiZmlsZSI6ImJ1bmRsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLy4uLy4uL3R5cGluZ3MvYmFieWxvbi5kLnRzXCIgLz5cclxuXHJcbmNsYXNzIEJhbGwge1xyXG4gICAgY29uc3RydWN0b3Ioc2NlbmUsIHNwYXduUG9zaXRpb24sIGJhbGxJZCwgY29sb3IgPSAxKSB7XHJcbiAgICAgICAgdGhpcy5taW5CYWxsU3BlZWQgPSA1O1xyXG4gICAgICAgIHRoaXMubWF4QmFsbFNwZWVkID0gMjA7XHJcblxyXG4gICAgICAgIHRoaXMuYmFsbCA9IEJBQllMT04uTWVzaEJ1aWxkZXIuQ3JlYXRlU3BoZXJlKCdwbGF5QmFsbCcsIHtcclxuICAgICAgICAgICAgc2VnbWVudHM6IDE2LFxyXG4gICAgICAgICAgICBkaWFtZXRlcjogMVxyXG4gICAgICAgIH0sIHNjZW5lKTtcclxuICAgICAgICB0aGlzLmJhbGwucGh5c2ljc0ltcG9zdG9yID0gbmV3IEJBQllMT04uUGh5c2ljc0ltcG9zdG9yKFxyXG4gICAgICAgICAgICB0aGlzLmJhbGwsXHJcbiAgICAgICAgICAgIEJBQllMT04uUGh5c2ljc0ltcG9zdG9yLlNwaGVyZUltcG9zdG9yLCB7XHJcbiAgICAgICAgICAgICAgICBtYXNzOiAxLFxyXG4gICAgICAgICAgICAgICAgZnJpY3Rpb246IDAsXHJcbiAgICAgICAgICAgICAgICByZXN0aXR1dGlvbjogMVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzY2VuZVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgdGhpcy5iYWxsLnBvc2l0aW9uID0gc3Bhd25Qb3NpdGlvbjtcclxuICAgICAgICB0aGlzLmJhbGwucGh5c2ljc0ltcG9zdG9yLnVuaXF1ZUlkID0gYmFsbElkO1xyXG5cclxuICAgICAgICB0aGlzLmluaXRpYWxQb3NpdGlvbiA9IHNwYXduUG9zaXRpb24uY2xvbmUoKTtcclxuICAgICAgICB0aGlzLmlzTGF1bmNoZWQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7XHJcbiAgICB9XHJcblxyXG4gICAgbG9ja1Bvc2l0aW9uVG9QbGF5ZXJQYWRkbGUocGxheWVyUGFkZGxlVmVsb2NpdHkpIHtcclxuICAgICAgICB0aGlzLmJhbGwucGh5c2ljc0ltcG9zdG9yLnNldExpbmVhclZlbG9jaXR5KHBsYXllclBhZGRsZVZlbG9jaXR5KTtcclxuICAgIH1cclxuXHJcbiAgICBsYXVuY2hCYWxsKGtleVN0YXRlcywgcGxheWVyUGFkZGxlVmVsb2NpdHkpIHtcclxuICAgICAgICBpZiAoa2V5U3RhdGVzWzMyXSkge1xyXG4gICAgICAgICAgICB0aGlzLmlzTGF1bmNoZWQgPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5iYWxsLnBoeXNpY3NJbXBvc3Rvci5zZXRMaW5lYXJWZWxvY2l0eShcclxuICAgICAgICAgICAgICAgIHBsYXllclBhZGRsZVZlbG9jaXR5LngsXHJcbiAgICAgICAgICAgICAgICAwLFxyXG4gICAgICAgICAgICAgICAgTWF0aC5yYW5kb20oKSAqIDEwXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNldENvbGxpc2lvbkNvbXBvbmVudHMoaW1wb3N0ZXJzKSB7XHJcbiAgICAgICAgdGhpcy5iYWxsLnBoeXNpY3NJbXBvc3Rvci5yZWdpc3Rlck9uUGh5c2ljc0NvbGxpZGUoaW1wb3N0ZXJzLCB0aGlzLm9uVHJpZ2dlckVudGVyKTtcclxuICAgIH1cclxuXHJcbiAgICBvblRyaWdnZXJFbnRlcihiYWxsUGh5c2ljc0ltcG9zdGVyLCBjb2xsaWRlZEFnYWluc3QpIHtcclxuICAgICAgICBsZXQgdmVsb2NpdHlYID0gY29sbGlkZWRBZ2FpbnN0LmdldExpbmVhclZlbG9jaXR5KCkueDtcclxuICAgICAgICBsZXQgdmVsb2NpdHlYQmFsbCA9IGJhbGxQaHlzaWNzSW1wb3N0ZXIuZ2V0TGluZWFyVmVsb2NpdHkoKS54O1xyXG4gICAgICAgIGxldCB2ZWxvY2l0eVogPSAtYmFsbFBoeXNpY3NJbXBvc3Rlci5nZXRMaW5lYXJWZWxvY2l0eSgpLno7XHJcblxyXG4gICAgICAgIGJhbGxQaHlzaWNzSW1wb3N0ZXIuc2V0TGluZWFyVmVsb2NpdHkobmV3IEJBQllMT04uVmVjdG9yMyhcclxuICAgICAgICAgICAgdmVsb2NpdHlYIC0gdmVsb2NpdHlYQmFsbCxcclxuICAgICAgICAgICAgMCxcclxuICAgICAgICAgICAgdmVsb2NpdHlaXHJcbiAgICAgICAgKSk7XHJcblxyXG4gICAgICAgIGNvbGxpZGVkQWdhaW5zdC5zZXRBbmd1bGFyVmVsb2NpdHkoQkFCWUxPTi5WZWN0b3IzLlplcm8oKSk7XHJcbiAgICB9XHJcblxyXG4gICAgbGltaXRCYWxsVmVsb2NpdHkoKSB7XHJcbiAgICAgICAgbGV0IHZlbG9jaXR5WiA9IHRoaXMuYmFsbC5waHlzaWNzSW1wb3N0b3IuZ2V0TGluZWFyVmVsb2NpdHkoKS56O1xyXG4gICAgICAgIGxldCB2ZWxvY2l0eVpBYnMgPSBNYXRoLmFicyh2ZWxvY2l0eVopO1xyXG4gICAgICAgIGxldCBjbGFtcGVkVmVsb2NpdHlaID0gQkFCWUxPTi5NYXRoVG9vbHMuQ2xhbXAodmVsb2NpdHlaQWJzLCB0aGlzLm1pbkJhbGxTcGVlZCwgdGhpcy5tYXhCYWxsU3BlZWQpO1xyXG4gICAgICAgIGxldCBkaXJlY3Rpb24gPSBNYXRoLnNpZ24odmVsb2NpdHlaKTtcclxuXHJcbiAgICAgICAgbGV0IHZlbG9jaXR5WCA9IHRoaXMuYmFsbC5waHlzaWNzSW1wb3N0b3IuZ2V0TGluZWFyVmVsb2NpdHkoKS54O1xyXG5cclxuICAgICAgICB0aGlzLmJhbGwucGh5c2ljc0ltcG9zdG9yLnNldExpbmVhclZlbG9jaXR5KFxyXG4gICAgICAgICAgICBuZXcgQkFCWUxPTi5WZWN0b3IzKFxyXG4gICAgICAgICAgICAgICAgdmVsb2NpdHlYLFxyXG4gICAgICAgICAgICAgICAgMCxcclxuICAgICAgICAgICAgICAgIGNsYW1wZWRWZWxvY2l0eVogKiBkaXJlY3Rpb25cclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlKGtleVN0YXRlcywgcGxheWVyUGFkZGxlVmVsb2NpdHkpIHtcclxuICAgICAgICBpZiAodGhpcy5pc0xhdW5jaGVkKVxyXG4gICAgICAgICAgICB0aGlzLmxpbWl0QmFsbFZlbG9jaXR5KCk7XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9ja1Bvc2l0aW9uVG9QbGF5ZXJQYWRkbGUocGxheWVyUGFkZGxlVmVsb2NpdHkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmlzTGF1bmNoZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5sYXVuY2hCYWxsKGtleVN0YXRlcywgcGxheWVyUGFkZGxlVmVsb2NpdHkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4vLi4vLi4vdHlwaW5ncy9iYWJ5bG9uLmQudHNcIiAvPlxyXG5cclxuY2xhc3MgUGFkZGxlIHtcclxuICAgIGNvbnN0cnVjdG9yKG5hbWUsIHNjZW5lLCBzcGF3blBvc2l0aW9uLCBwYWRkbGVJZCwgaXNBSSwgY29sb3IgPSAxKSB7XHJcbiAgICAgICAgdGhpcy5wYWRkbGUgPSBCQUJZTE9OLk1lc2hCdWlsZGVyLkNyZWF0ZUJveChgcGFkZGxlJHtuYW1lfWAsIHtcclxuICAgICAgICAgICAgd2lkdGg6IDUsXHJcbiAgICAgICAgICAgIGhlaWdodDogMSxcclxuICAgICAgICAgICAgZGVwdGg6IDFcclxuICAgICAgICB9LCBzY2VuZSk7XHJcbiAgICAgICAgdGhpcy5wYWRkbGUucG9zaXRpb24gPSBzcGF3blBvc2l0aW9uO1xyXG4gICAgICAgIHRoaXMucGFkZGxlLnBoeXNpY3NJbXBvc3RvciA9IG5ldyBCQUJZTE9OLlBoeXNpY3NJbXBvc3RvcihcclxuICAgICAgICAgICAgdGhpcy5wYWRkbGUsXHJcbiAgICAgICAgICAgIEJBQllMT04uUGh5c2ljc0ltcG9zdG9yLkJveEltcG9zdG9yLCB7XHJcbiAgICAgICAgICAgICAgICBtYXNzOiAxLFxyXG4gICAgICAgICAgICAgICAgZnJpY3Rpb246IDAsXHJcbiAgICAgICAgICAgICAgICByZXN0aXR1dGlvbjogMFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzY2VuZVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgdGhpcy5wYWRkbGUucGh5c2ljc0ltcG9zdG9yLnNldExpbmVhclZlbG9jaXR5KEJBQllMT04uVmVjdG9yMy5aZXJvKCkpO1xyXG4gICAgICAgIHRoaXMucGFkZGxlLnBoeXNpY3NJbXBvc3Rvci51bmlxdWVJZCA9IHBhZGRsZUlkO1xyXG5cclxuICAgICAgICB0aGlzLmluaXRpYWxQb3NpdGlvbiA9IHNwYXduUG9zaXRpb24uY2xvbmUoKTtcclxuICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7XHJcbiAgICAgICAgdGhpcy5tb3ZlbWVudFNwZWVkID0gNTtcclxuXHJcbiAgICAgICAgdGhpcy5pc0FJID0gaXNBSTtcclxuICAgIH1cclxuXHJcbiAgICBtb3ZlUGFkZGxlKGtleVN0YXRlcykge1xyXG4gICAgICAgIGlmIChrZXlTdGF0ZXNbMzddKSB7XHJcbiAgICAgICAgICAgIHRoaXMucGFkZGxlLnBoeXNpY3NJbXBvc3Rvci5zZXRMaW5lYXJWZWxvY2l0eShCQUJZTE9OLlZlY3RvcjMuTGVmdCgpLnNjYWxlKHRoaXMubW92ZW1lbnRTcGVlZCkpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoa2V5U3RhdGVzWzM5XSkge1xyXG4gICAgICAgICAgICB0aGlzLnBhZGRsZS5waHlzaWNzSW1wb3N0b3Iuc2V0TGluZWFyVmVsb2NpdHkoQkFCWUxPTi5WZWN0b3IzLlJpZ2h0KCkuc2NhbGUodGhpcy5tb3ZlbWVudFNwZWVkKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoKCFrZXlTdGF0ZXNbMzddICYmICFrZXlTdGF0ZXNbMzldKSB8fCAoa2V5U3RhdGVzWzM3XSAmJiBrZXlTdGF0ZXNbMzldKSlcclxuICAgICAgICAgICAgdGhpcy5wYWRkbGUucGh5c2ljc0ltcG9zdG9yLnNldExpbmVhclZlbG9jaXR5KEJBQllMT04uVmVjdG9yMy5aZXJvKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIG1vdmVQYWRkbGVBSShiYWxsTWVzaCkge1xyXG4gICAgICAgIGxldCBkZXNpcmVkRGlyZWN0aW9uID0gTWF0aC5zaWduKGJhbGxNZXNoLnBvc2l0aW9uLnggLSB0aGlzLnBhZGRsZS5wb3NpdGlvbi54KTtcclxuXHJcbiAgICAgICAgaWYgKGRlc2lyZWREaXJlY3Rpb24gPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHRoaXMucGFkZGxlLnBoeXNpY3NJbXBvc3Rvci5zZXRMaW5lYXJWZWxvY2l0eShCQUJZTE9OLlZlY3RvcjMuTGVmdCgpLnNjYWxlKHRoaXMubW92ZW1lbnRTcGVlZCkpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZGVzaXJlZERpcmVjdGlvbiA9PT0gMSkge1xyXG4gICAgICAgICAgICB0aGlzLnBhZGRsZS5waHlzaWNzSW1wb3N0b3Iuc2V0TGluZWFyVmVsb2NpdHkoQkFCWUxPTi5WZWN0b3IzLlJpZ2h0KCkuc2NhbGUodGhpcy5tb3ZlbWVudFNwZWVkKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5wYWRkbGUucGh5c2ljc0ltcG9zdG9yLnNldExpbmVhclZlbG9jaXR5KEJBQllMT04uVmVjdG9yMy5aZXJvKCkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGUoa2V5U3RhdGVzLCBiYWxsKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzQUkpXHJcbiAgICAgICAgICAgIHRoaXMubW92ZVBhZGRsZShrZXlTdGF0ZXMpO1xyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgdGhpcy5tb3ZlUGFkZGxlQUkoYmFsbCk7XHJcblxyXG4gICAgICAgIHRoaXMucGFkZGxlLnBoeXNpY3NJbXBvc3Rvci5zZXRBbmd1bGFyVmVsb2NpdHkoQkFCWUxPTi5WZWN0b3IzLlplcm8oKSk7XHJcbiAgICB9XHJcbn1cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLy4uLy4uL3R5cGluZ3MvYmFieWxvbi5kLnRzXCIgLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4vcGFkZGxlLmpzXCIgLz5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4vYmFsbC5qc1wiIC8+XHJcblxyXG4vLyBUb0RvOiBSZW1vdmUgYHNob3dCb3VuZGluZ0JveGAgZnJvbSBhbGwgYm9kaWVzXHJcblxyXG5jb25zdCBjYW52YXNIb2xkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2FudmFzLWhvbGRlcicpO1xyXG5jb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcclxuY2FudmFzLndpZHRoID0gd2luZG93LmlubmVyV2lkdGggLSAyNTtcclxuY2FudmFzLmhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCAtIDMwO1xyXG5jYW52YXNIb2xkZXIuYXBwZW5kQ2hpbGQoY2FudmFzKTtcclxuY29uc3QgZW5naW5lID0gbmV3IEJBQllMT04uRW5naW5lKGNhbnZhcywgdHJ1ZSk7XHJcblxyXG5jb25zdCBrZXlTdGF0ZXMgPSB7XHJcbiAgICAzMjogZmFsc2UsIC8vIFNQQUNFXHJcbiAgICAzNzogZmFsc2UsIC8vIExFRlRcclxuICAgIDM4OiBmYWxzZSwgLy8gVVBcclxuICAgIDM5OiBmYWxzZSwgLy8gUklHSFRcclxuICAgIDQwOiBmYWxzZSAvLyBET1dOXHJcbn07XHJcbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGV2ZW50KSA9PiB7XHJcbiAgICBpZiAoZXZlbnQua2V5Q29kZSBpbiBrZXlTdGF0ZXMpXHJcbiAgICAgICAga2V5U3RhdGVzW2V2ZW50LmtleUNvZGVdID0gdHJ1ZTtcclxufSk7XHJcbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIChldmVudCkgPT4ge1xyXG4gICAgaWYgKGV2ZW50LmtleUNvZGUgaW4ga2V5U3RhdGVzKVxyXG4gICAgICAgIGtleVN0YXRlc1tldmVudC5rZXlDb2RlXSA9IGZhbHNlO1xyXG59KTtcclxuXHJcbmNvbnN0IGNyZWF0ZVNjZW5lID0gKCkgPT4ge1xyXG4gICAgY29uc3Qgc2NlbmUgPSBuZXcgQkFCWUxPTi5TY2VuZShlbmdpbmUpO1xyXG4gICAgc2NlbmUuZW5hYmxlUGh5c2ljcyhuZXcgQkFCWUxPTi5WZWN0b3IzKDAsIC05LjgxLCAwKSwgbmV3IEJBQllMT04uQ2Fubm9uSlNQbHVnaW4oKSk7XHJcbiAgICBzY2VuZS5jb2xsaXNpb25zRW5hYmxlZCA9IHRydWU7XHJcbiAgICBzY2VuZS53b3JrZXJDb2xsaXNpb25zID0gdHJ1ZTtcclxuXHJcbiAgICBjb25zdCBjYW1lcmEgPSBuZXcgQkFCWUxPTi5GcmVlQ2FtZXJhKCdtYWluQ2FtZXJhJywgbmV3IEJBQllMT04uVmVjdG9yMygwLCAyMCwgLTYwKSwgc2NlbmUpO1xyXG4gICAgY2FtZXJhLnNldFRhcmdldChCQUJZTE9OLlZlY3RvcjMuWmVybygpKTtcclxuXHJcbiAgICBjb25zdCBsaWdodCA9IG5ldyBCQUJZTE9OLkhlbWlzcGhlcmljTGlnaHQoJ21haW5MaWdodCcsIG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgMSwgMCksIHNjZW5lKTtcclxuXHJcbiAgICBjb25zdCBncm91bmQgPSBCQUJZTE9OLk1lc2hCdWlsZGVyLkNyZWF0ZUdyb3VuZCgnbWFpbkdyb3VuZCcsIHtcclxuICAgICAgICB3aWR0aDogMzIsXHJcbiAgICAgICAgaGVpZ2h0OiA3MCxcclxuICAgICAgICBzdWJkaXZpc2lvbnM6IDJcclxuICAgIH0sIHNjZW5lKTtcclxuICAgIGdyb3VuZC5wb3NpdGlvbiA9IEJBQllMT04uVmVjdG9yMy5aZXJvKCk7XHJcbiAgICBncm91bmQucGh5c2ljc0ltcG9zdG9yID0gbmV3IEJBQllMT04uUGh5c2ljc0ltcG9zdG9yKFxyXG4gICAgICAgIGdyb3VuZCxcclxuICAgICAgICBCQUJZTE9OLlBoeXNpY3NJbXBvc3Rvci5Cb3hJbXBvc3Rvciwge1xyXG4gICAgICAgICAgICBtYXNzOiAwLFxyXG4gICAgICAgICAgICBmcmljdGlvbjogMCxcclxuICAgICAgICAgICAgcmVzdGl0dXRpb246IDBcclxuICAgICAgICB9LCBzY2VuZSk7XHJcblxyXG4gICAgY29uc3QgbGVmdEJhciA9IEJBQllMT04uTWVzaEJ1aWxkZXIuQ3JlYXRlQm94KCdsZWZ0QmFyJywge1xyXG4gICAgICAgIHdpZHRoOiAyLFxyXG4gICAgICAgIGhlaWdodDogMixcclxuICAgICAgICBkZXB0aDogNzBcclxuICAgIH0sIHNjZW5lKTtcclxuICAgIGxlZnRCYXIucG9zaXRpb24gPSBuZXcgQkFCWUxPTi5WZWN0b3IzKC0xNSwgMSwgMCk7XHJcbiAgICBsZWZ0QmFyLnBoeXNpY3NJbXBvc3RvciA9IG5ldyBCQUJZTE9OLlBoeXNpY3NJbXBvc3RvcihcclxuICAgICAgICBsZWZ0QmFyLFxyXG4gICAgICAgIEJBQllMT04uUGh5c2ljc0ltcG9zdG9yLkJveEltcG9zdG9yLCB7XHJcbiAgICAgICAgICAgIG1hc3M6IDAsXHJcbiAgICAgICAgICAgIGZyaWN0aW9uOiAwLFxyXG4gICAgICAgICAgICByZXN0aXR1dGlvbjogMVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHJpZ2h0QmFyID0gQkFCWUxPTi5NZXNoQnVpbGRlci5DcmVhdGVCb3goJ3JpZ2h0QmFyJywge1xyXG4gICAgICAgIHdpZHRoOiAyLFxyXG4gICAgICAgIGhlaWdodDogMixcclxuICAgICAgICBkZXB0aDogNzBcclxuICAgIH0sIHNjZW5lKTtcclxuICAgIHJpZ2h0QmFyLnBvc2l0aW9uID0gbmV3IEJBQllMT04uVmVjdG9yMygxNSwgMSwgMCk7XHJcbiAgICByaWdodEJhci5waHlzaWNzSW1wb3N0b3IgPSBuZXcgQkFCWUxPTi5QaHlzaWNzSW1wb3N0b3IoXHJcbiAgICAgICAgcmlnaHRCYXIsXHJcbiAgICAgICAgQkFCWUxPTi5QaHlzaWNzSW1wb3N0b3IuQm94SW1wb3N0b3IsIHtcclxuICAgICAgICAgICAgbWFzczogMCxcclxuICAgICAgICAgICAgZnJpY3Rpb246IDAsXHJcbiAgICAgICAgICAgIHJlc3RpdHV0aW9uOiAxXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHNjZW5lO1xyXG59O1xyXG5jb25zdCBzY2VuZSA9IGNyZWF0ZVNjZW5lKCk7XHJcbi8vIG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgMC41LCAtMzQpXHJcblxyXG5jb25zdCBwbGF5ZXJfMSA9IG5ldyBQYWRkbGUoJ3BsYXllcl8xJywgc2NlbmUsIG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgMC41LCAtMzQpLCAyLCBmYWxzZSk7XHJcbmNvbnN0IGFpUGxheWVyID0gbmV3IFBhZGRsZSgnYWlQbGF5ZXInLCBzY2VuZSwgbmV3IEJBQllMT04uVmVjdG9yMygwLCAwLjUsIDM0KSwgMywgdHJ1ZSk7XHJcbmNvbnN0IHBsYXlpbmdCYWxsID0gbmV3IEJhbGwoc2NlbmUsIG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgMC41LCAtMzMpLCAxKTtcclxuXHJcbmVuZ2luZS5ydW5SZW5kZXJMb29wKCgpID0+IHtcclxuICAgIHBsYXlpbmdCYWxsLnVwZGF0ZShrZXlTdGF0ZXMsIHBsYXllcl8xLnBhZGRsZS5waHlzaWNzSW1wb3N0b3IuZ2V0TGluZWFyVmVsb2NpdHkoKSk7XHJcbiAgICBwbGF5ZXJfMS51cGRhdGUoa2V5U3RhdGVzLCBwbGF5aW5nQmFsbC5iYWxsKTtcclxuICAgIGFpUGxheWVyLnVwZGF0ZShrZXlTdGF0ZXMsIHBsYXlpbmdCYWxsLmJhbGwpO1xyXG4gICAgc2NlbmUucmVuZGVyKCk7XHJcbn0pOyJdfQ==
